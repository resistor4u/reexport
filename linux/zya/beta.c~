extern char zya45[408];
extern char zya60;
extern void *zya99;
extern long zya144;
extern char zya224;
extern char zya597[280];
extern int zya679;
extern char zya787[144];
extern long zya935;
extern char zya1094;

#ifdef SIMPLE_JMP
#define IMPORT(import, alias) \
    extern void *import(); \
    void *alias() { return import(); } /* create code trampoline */
#define IMPORT_PRIVATE(anchor, offset, alias) \
    void *alias(void *a, void *b, void *c, void *d, void *e, void *f) \
    { \
        extern void *anchor(); \
        return ((void *(*)())((unsigned long)anchor + offset))(a, b, c, d, e, f); \
    }
#else /* IFUNC */
#define IMPORT(import, alias) \
    extern void *import(); \
    static void *(*resolve_##alias(void))() { return import; } \
    void *alias() __attribute__((ifunc("resolve_" #alias)));
#define IMPORT_PRIVATE(anchor, offset, alias) \
    extern void *anchor(); \
    static void *(*resolve_##alias(void))() { return (void *(*)())((unsigned long)anchor + offset); } \
    void *alias() __attribute__((ifunc("resolve_" #alias)));
#endif /* IFUNC */

IMPORT(zya146, decode_insn)

IMPORT_PRIVATE(create_strlit, 0x4950, cfgopt_t__apply)

#define _GNU_SOURCE
#include <dlfcn.h>
#include <link.h>
#include <string.h>
#include <stdio.h>

#define COPY(sym) \
    do { \
        void *that = dlsym(RTLD_NEXT, #sym); \
        if (that) { \
            memcpy(&sym, that, sizeof(sym)); \
        } \
    } while (0)

void
initme(void)
{
    /* pull in data imports */
    COPY(zya45);
    COPY(zya60);
    COPY(zya99);
    COPY(zya144);
    COPY(zya224);
    COPY(zya597);
    COPY(zya679);
    COPY(zya787);
    COPY(zya935);
    COPY(zya1094);
    printf("COPY ok\n");
}

void
_start(void)
{
    __builtin_trap();
}

/*
 * function wrapping: this is slightly different than just aliasing, because we need
 * to provide BOTH symbols *and* rely on the other library for backend implementation
 */

#include <stdio.h>

int
run_plugin(char **a, long b)
{
    static unsigned long func = 0;
    if (!func) {
        func = (unsigned long)dlsym(RTLD_NEXT, "zya936");
    }
    if (a) {
        printf("%s: %s\n", __func__, a[6]);
    }
    return ((typeof(run_plugin) *)func)(a, b);
}
int zya936(char **a, long b) __attribute__((alias("run_plugin")));
